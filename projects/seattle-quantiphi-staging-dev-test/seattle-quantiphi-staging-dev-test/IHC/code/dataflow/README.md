# Dataflow Pipeline
### File highlighting steps to follow for deploying a dataflow job and the parameters associated with it.

## Input and Output
* **Input**
  * Input path for the dataflow job can be provided in the config file. The input file is a csv containing gcs slide path in each row. An example input csv with 10 slides can be found here:- `gs://seagen_dataflow/input_csv/input_paths.csv`

* **Output**
  * Output will be stored at the gcs location provided in the config file after the dataflow job finishes. The output folder will contain two sub-folders:
    1) slide_preds: This folder will contain an output json for each slide, which will contain the predicted label of the slide and the fraction cover of various classes present in the slide.<br>
    2) tile_preds: This folder contains a csv for each slide, which will contain x and y coordinates, the class predicted at that cordinate and the confidence of that class.<br> 
  An example output folder:- `seagen_dataflow/results_runner/run-online-10slides/`

## Configuration
The config file for running the dataflow pipeline is located at `code/dataflow/config.json`. <br>
Python script `code/dataflow/run.py` will use this config file to access all the parameters that are necessary for building the pipeline and its functions.
Following is a brief description on the parameters present in the config file. <br>
## **`pipeline_config`**
Arguments to be used while building the dataflow pipeline
* **Description:**
  * **job_name**: Name of the dataflow job (str) ("test-1")
  * **input_path**: GCS path of the input csv containing a slide path in each row. (str) ("gs://seagen_dataflow/input_csvs/input_paths.csv")
  * **output_path**: GCS path of the output directory. (str) ("gs://seagen_dataflow/results_runner/")
  * **num_workers**: Number of workers to initiate the pipeline (int) (1)
  * **max_num_workers**: Maximum number of workers allowed after autoscaling. (int) (24) *Note: Refer to AutoML Deployment section for information regarding how to tune this parameter.*
  * **run_local**: Whether to run a test on local instance rather than dataflow runner. (bool) (false)
  * **project_id**: Project ID (str)
  * **region**: The region in which the job will be deployed. (str) ("us-west1")
  * **store_tiled_img**: Whether to store the tiles on GCS as they are generated by the pipeline. (bool) (false) *Note: Setting this to true would create significant overhead* 
  * **automl_mode**: AutoML mode to be used. (str) ("online") *Options: "online", "edge"*

* **Example:**
```
"pipeline_config":{
        "job_name": "run-online-10slides",
        "input_path": "gs://seagen_dataflow/input_csvs/input_paths.csv",
        "output_path": "gs://seagen_dataflow/results_runner",
        "num_workers": 1,
        "max_num_workers": 28,
        "run_local": false,
        "project_id": "ihc-qc-sandbox",
        "region": "us-west1",
        "store_tiled_img": false,
        "automl_mode": "online"
    }
```

## **`function_config`**
Arguments to be used by functions in the pipeline
#### **`tiling_transform`**
* **Description:** 
    * **tile_size**: height, width of the tile to be used (list of two ints) (1024, 1024) 
    * **batch_size**: Number of tiles in a single batch to be sent to automl edge. (int) (8) *Note: This parameter is only used when the automl_mode is "edge"* 

* **Example:**
```
"tiling_transform":{
            "tile_size": [1024,1024],
            "batch_size": 4
        }
```

#### **`automl_prediction`**
* **Description:** 
    * **edge**
      * **endpoint**: Endpoint where the edge model is deployed. Refer to the AutoML deployment section to know how to deploy an edge model. (str) ("http://192.168.2.6:8501/v1/models/default:predict")
      * **confidence_threshold**: Minimum confidence required to classify a tile. (float) (0.01) *Note: Setting this value to ~0 will automatically just take the class with the maximum confidence and the tile prediction will never be "uncertain".*
    * **online**
      * **project_id**: Project ID
      * **model_id**: Model ID of the deployed model. Refer to the AutoML deployment section to know how to deploy an online model. (str) ("ICN2690384006888816640")
      * **confidence_threshold**: Minimum confidence required to classify a tile. (float) (0.01) *Note: Setting this value to ~0 will automatically just take the class with the maximum confidence and the tile prediction will never be "uncertain".*

* **Example:**
```
"automl_prediction":{
        "edge":{
            "endpoint": "http://192.168.2.6:8501/v1/models/default:predict",
            "confidence_threshold": 0.01
        },
        "online":{
            "project_id": "ihc-qc-sandbox",
            "model_id": "ICN2690384006888816640",
            "confidence_threshold": 0.01
        }
    }
```

#### **`store_on_bigquery`**
* **Description:**
    * **store_tile_preds**: Whether to store tile preds on BigQuery. (bool) (false) *Note: Setting this to true in case of multiple input slides (>5) can cause Quota Errors because of high number of writing operations.*
    * **tile_level_preds**: Location of table in the format "dataset_id.table_id". (str) ("seagen_quantiphi.tile_preds")
    * **store_slide_preds**: Whether to store slide preds on Bigquery. (bool) (false) *Note: Setting this to true in case of multiple input slides (>5) can cause Quota Errors because of high number of writing operations.*
    * **slide_level_preds**: Location of table in the format "dataset_id.table_id". (str) ("seagen_quantiphi.slide_preds")

* **Example:**
```
"store_on_bigquery":{
        "store_tile_preds": false,
        "tile_level_preds": "seagen_quantiphi.tile_preds",
        "store_slide_preds": false,
        "slide_level_preds": "seagen_quantiphi.slide_preds"
    }
```


#### **`Visualization`**
* This section has configurable parameters for IHC Visualization.
* **image_size**
  * This parameter determines the width of the output visualization image. The height of the image will be automatically determined according to the width and aspect ratio.
* **cmap_name**
   * This parameter allows user to choose the color palette for the labels. 
   * To get a better understanding of available color palettes from the given link.           
   
   *   https://seaborn.pydata.org/tutorial/color_palettes.html
   

* **Example:**
```
"visualization":{
		"image_size": 3242,
		"cmap_name": "tab10"
	}
```



## AutoML Model Deployment
AutoML can be deployed on a cloud hosted (online) server or on an instance (edge).
* **Online**
  * The online model can be deployed through the AutoML Web UI. [AutoML Vision Deploy Online](https://cloud.google.com/vision/automl/docs/deploy#automl_deploy_model-web)
  * The number of nodes the model is deployed on should be sufficiently high to handle the traffic from dataflow workers. Example: If the maximum number of dataflow workers (max_num_workers) is reaching 24, the AutoML model should atleast be deployed on 8 nodes.
* **Edge**
  * The edge model can be deployed on an instance using the container tutorial. [AutoML Vision Edge Deployment](https://cloud.google.com/vision/automl/docs/containers-gcs-tutorial)
  * The instance type recommended for deployment is "Efficient Instance - 16vCPUs, 16 GB RAM". In the case of edge deployment, you can set your max_num_workers to a high value (128), since the edge model handles excess traffic internally. (As opposed to "online" AutoML which cannot handle extra traffic, so fine tuning max_num_workers parameter in that case is necessary.)
* **Trained Models**
  * The final trained models are:
    1) Online: (Name: "all_subsets_combined_online_v1", Model-ID: ICN2690384006888816640)
    2) Edge: (Name: "all_subsets_combined_edge_v1", Model-ID: ICN404701642882023424, GCS path: "gs://seagen-quantiphi/subset_all_combined/edge_v1")



## Running Dataflow Job
The run.py script is used to build and deploy the pipeline. The dependencies are automatically installed on the dataflow runner using the setup.py script which is called inside the run.py script by default.  
To deploy a dataflow job use the following commands:<br>
```bash
cd code/dataflow
```
```bash
python3 run.py
```
*Note: The script run.py will use config.json to extract the parameters. If changes are made to config.json, the run.py script needs to be executed again.* 