# **Dataflow Pipeline and Flex Template**
### File highlighting steps to follow to create a flex Template, run a Dataflow job and the parameters associated with it.

## **Create Dataflow Template and Run Dataflow Job**
* ## **Create Dataflow Template**
#### To create the Dataflow Template , execute the below shell script in the Terminal:
**Note:** Please ignore this step if the template is already built.
```
/bin/bash build_flex_template_script.sh
```

* ## **Run Dataflow Job**

### 1) Using Cloud Functions:
Upload an input CSV file to the bucket **seagen_ihc_input_cf**, the Cloud Function will be triggered and a dataflow job will be run.
#### **Note:** The input file should be a csv containing gcs slide path in each row. An example input csv with 10 slides can be found here:- `gs://seagen_dataflow/input_csv/input_paths.csv`
### 2) Using gcloud:
Execute the below command in the current directory on the terminal:

```
/bin/bash run_dataflow_flex_job.sh
```
Example gcloud command to run a dataflow job:
```
gcloud dataflow flex-template run dev-flex_job_1 \
--template-file-gcs-location "gs://seagen_dataflow/templates/dev_ihc/v2.json" \
--parameters config_file="seagen_dataflow/ihc_config/config.json" \
--parameters input_path="gs://seagen_dataflow/input_csvs/input_paths_1.csv" \
--parameters output_path="gs://seagen_dataflow/results_runner/dev-ihc-flex-output" \
--region "us-west1" \
--subnetwork "regions/us-west1/subnetworks/oregon-subnet"
```
## Configuration
The config file for running the dataflow pipeline is located at `gs://seagen_dataflow/ihc_config/config.json`. <br>
Python script `cicd/script.py` will use this config file to access all the parameters that are necessary for building the pipeline and its functions.
Following is a brief description on the parameters present in the config file. <br>
## **`pipeline_config`**
* **Description:**
  * **job_name**: Name of the dataflow job (str) ("test-1")
  * **num_workers**: Number of workers to initiate the pipeline (int) (1)
  * **max_num_workers**: Maximum number of workers allowed after autoscaling. (int) (24) *Note: Refer to AutoML Deployment section for information regarding how to tune this parameter.*
  * **run_local**: Whether to run a test on local instance rather than dataflow runner. (bool) (false)
  * **project_id**: Project ID (str)
  * **region**: The region in which the job will be deployed. (str) ("us-west1")
  * **store_tiled_img**: Whether to store the tiles on GCS as they are generated by the pipeline. (bool) (false) *Note: Setting this to true would create significant overhead* 
  * **automl_mode**: AutoML mode to be used. (str) ("online") *Options: "online", "edge"*

* **Example:**
```
"pipeline_config":{
        "job_name": "run-online-10slides",
        "num_workers": 1,
        "max_num_workers": 28,
        "run_local": false,
        "project_id": "ihc-qc-sandbox",
        "region": "us-west1",
        "store_tiled_img": false,
        "automl_mode": "online"
    }
```

## **`function_config`**
Arguments to be used by functions in the pipeline
#### **`tiling_transform`**
* **Description:** 
    * **tile_size**: height, width of the tile to be used (list of two ints) (1024, 1024) 
    * **batch_size**: Number of tiles in a single batch to be sent to automl edge. (int) (8) *Note: This parameter is only used when the automl_mode is "edge"* 

* **Example:**
```
"tiling_transform":{
            "tile_size": [1024,1024],
            "batch_size": 4
        }
```

#### **`automl_prediction`**
* **Description:** 
    * **edge**
      * **endpoint**: Endpoint where the edge model is deployed. Refer to the AutoML deployment section to know how to deploy an edge model. (str) ("http://192.168.2.6:8501/v1/models/default:predict")
      * **confidence_threshold**: Minimum confidence required to classify a tile. (float) (0.01) *Note: Setting this value to ~0 will automatically just take the class with the maximum confidence and the tile prediction will never be "uncertain".*
    * **online**
      * **project_id**: Project ID
      * **model_id**: Model ID of the deployed model. Refer to the AutoML deployment section to know how to deploy an online model. (str) ("ICN2690384006888816640")
      * **confidence_threshold**: Minimum confidence required to classify a tile. (float) (0.01) *Note: Setting this value to ~0 will automatically just take the class with the maximum confidence and the tile prediction will never be "uncertain".*

* **Example:**
```
"automl_prediction":{
        "edge":{
            "endpoint": "http://192.168.2.6:8501/v1/models/default:predict",
            "confidence_threshold": 0.01
        },
        "online":{
            "project_id": "ihc-qc-sandbox",
            "model_id": "ICN2690384006888816640",
            "confidence_threshold": 0.01
        }
    }
```

#### **`store_on_bigquery`**
* **Description:**
    * **store_tile_preds**: Whether to store tile preds on BigQuery. (bool) (false) *Note: Setting this to true in case of multiple input slides (>5) can cause Quota Errors because of high number of writing operations.*
    * **tile_level_preds**: Location of table in the format "dataset_id.table_id". (str) ("seagen_quantiphi.tile_preds")
    * **store_slide_preds**: Whether to store slide preds on Bigquery. (bool) (false) *Note: Setting this to true in case of multiple input slides (>5) can cause Quota Errors because of high number of writing operations.*
    * **slide_level_preds**: Location of table in the format "dataset_id.table_id". (str) ("seagen_quantiphi.slide_preds")

* **Example:**
```
"store_on_bigquery":{
        "store_tile_preds": false,
        "tile_level_preds": "seagen_quantiphi.dev_tile_preds",
        "store_slide_preds": false,
        "slide_level_preds": "seagen_quantiphi.dev_slide_preds"
    }
```


#### **`Visualization`**
* This section has configurable parameters for IHC Visualization.
* **image_size**
  * This parameter determines the width of the output visualization image. The height of the image will be automatically determined according to the width and aspect ratio.
* **cmap_name**
   * This parameter allows user to choose the color palette for the labels. 
   * To get a better understanding of available color palettes from the given link.           
   
   *   https://seaborn.pydata.org/tutorial/color_palettes.html
   

* **Example:**
```
"visualization":{
		"image_size": 3242,
		"cmap_name": "tab10"
	}
```



## AutoML Model Deployment
AutoML can be deployed on a cloud hosted (online) server or on an instance (edge).
* **Online**
  * The online model can be deployed through the AutoML Web UI. [AutoML Vision Deploy Online](https://cloud.google.com/vision/automl/docs/deploy#automl_deploy_model-web)
  * The number of nodes the model is deployed on should be sufficiently high to handle the traffic from dataflow workers. Example: If the maximum number of dataflow workers (max_num_workers) is reaching 24, the AutoML model should atleast be deployed on 8 nodes.
* **Edge**
  * The edge model can be deployed on an instance using the container tutorial. [AutoML Vision Edge Deployment](https://cloud.google.com/vision/automl/docs/containers-gcs-tutorial)
  * The instance type recommended for deployment is "Efficient Instance - 16vCPUs, 16 GB RAM". In the case of edge deployment, you can set your max_num_workers to a high value (128), since the edge model handles excess traffic internally. (As opposed to "online" AutoML which cannot handle extra traffic, so fine tuning max_num_workers parameter in that case is necessary.)
* **Trained Models**
  * The final trained models are:
    1) Online: (Name: "all_subsets_combined_online_v1", Model-ID: ICN2690384006888816640)
    2) Edge: (Name: "all_subsets_combined_edge_v1", Model-ID: ICN404701642882023424, GCS path: "gs://seagen-quantiphi/subset_all_combined/edge_v1")

## **Output**
  * Output will be stored at the gcs location provided in the config file after the dataflow job finishes. The output folder will contain two sub-folders:
    1) slide_preds: This folder will contain an output json for each slide, which will contain the predicted label of the slide and the fraction cover of various classes present in the slide.<br>
    2) tile_preds: This folder contains a csv for each slide, which will contain x and y coordinates, the class predicted at that cordinate and the confidence of that class.<br> 
  An example output folder:- `seagen_dataflow/results_runner/run-online-10slides/`
* The Authenticated URL's of the objects stored in GCS bucket will be stored in a BigQuery table.
  * **tile_level_preds**: Location of table in the format "dataset_id.table_id". (str) ("seagen_quantiphi.tile_preds")
  * **slide_level_preds**: Location of table in the format "dataset_id.table_id". (str) ("seagen_quantiphi.slide_preds_copy")
